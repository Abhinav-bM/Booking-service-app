<!doctype html>
<html class="no-js" lang="">


<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Checkout</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="manifest" href="">
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">

    <!-- CSS here -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css">
    <link rel="stylesheet" href="/css/fontawesome.min.css">
    <link rel="stylesheet" href="/css/jquery-ui.css">
    <link rel="stylesheet" href="/css/animate.min.css">
    <link rel="stylesheet" href="/css/magnific-popup.css">
    <link rel="stylesheet" href="/css/fontawesome-all.min.css">
    <link rel="stylesheet" href="/css/meanmenu.css">
    <link rel="stylesheet" href="/css/slick.css">
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.4.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link
        rel="stylesheet"
        type="text/css"
        href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script
        type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
    <style>
        .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        }

        .modal-content1 {
        background-color: white;
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
        border-radius: 5px;
        }

        .modal-header1 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        }

        .modal-header1 .modal-title1 {
        margin: 0;
        }

        .modal-header1 .close {
        color: #aaa;
        text-decoration: none;
        font-size: 24px;
        }

        .modal-body1 {
        max-height: 400px;
        overflow-y: auto; 
        padding: 20px 0;
        }

        .modal-footer {
        text-align: right;
        }

        .btn-open-modal {
        display: inline-block;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        }

        .btn-close-modal {
        padding: 10px 20px;
        background-color: #dc3545;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        }

        .modal:target {
        display: block;
        }

    </style>

</head>

<body>

   

    <!-- header -->
    <%- include('../partials/header') %>
    

    <main>
        <section class="py-2">
            <div class="d-xl-flex d-lg-flex d-md-flex d-sm-grid justify-content-center">
                <div class="col-xl-5 col-lg-5 col-md-6">

                  
                    
                    <h4 class="pt-4 " style="margin-left: 6px;">Delivery Address</h4>
                    <div class="p-2" >
                        <!-- Checkbox for Delivery Address -->
                        <% addresses.forEach((address,index) => { %>
                        <div class="mb-3 px-4 pt-3 pb-1 form-check rounded" style="border: 2px solid rgb(223, 223, 223); background-color: rgb(246, 246, 246);">
                            <input type="checkbox" class="form-check-input delivery-address" id="address_<%= address._id %>" data-address-id="<%= address._id %>" <% if (index === 0) { %> checked <% } %>>
                            <label for="address_<%= address._id %>" class="form-check-label">
                            <p class="m-0"><%= address.name %></p>
                            <p class="m-0"><%= address.address %>, <%= address.district %>, <%= address.state %>, <%= address.zip %></p>
                            <p class="m-0"><%= address.phone %> , <%= address.email %></p>
                        </div>
                        <% }) %>

                        <!-- BUTTON TRIGGER ADD ADDRESS MODAL -->
                        <button type="button" class="" data-bs-toggle="modal" data-bs-target="#exampleModal" style="background-color: #525151; color: white; width: 150px; border-radius: 5px;" >
                            Add new address
                        </button>
                    </div>
                </div>

                <div class="col-xl-5 col-lg-5 col-md-6">
                    
                                <div class="your-order mb-30 rounded" style="margin-top: 39px;">
                                    <h3>Your booking</h3>
                                    <div class="your-order-table table-responsive">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th class="product-Image"><img src="<%= service.images[0] %>" alt="" width="120px"></th>
                                                    <th class="product-details">
                                                        <small><strong>Title : <%= service.title %></strong></small><br>
                                                        <small><strong>Price : <%= service.sellingPrice%></strong></small><br>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                               
                                                <tr class="cart_item">
                                                    <td class="product-name">
                                                        Total Service Price
                                                    </td>
                                                    <td class="product-total">
                                                        <span class="amount" id="productTotal"><%= service.sellingPrice %></span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
              
                                            
                                                <tr class="order-total">
                                                    <th>Booking Total</th>
                                                    <td><strong><span class="text-secondary" id="orderTotal"><%= service.sellingPrice %></span></strong>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>

                                    <div class="payment-method">
                                        <h4>PAYMENT METHOD</h4>

                                        <div class="accordion" id="accordionExample">
                                            <div class="card">
                                                <div class="card-header" id="headingTwo">
                                                    <h5 class="mb-0">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="cashOnDelivery" id="cashOnDeliveryCheckbox">
                                                            <label class="form-check-label" for="cashOnDeliveryCheckbox">
                                                                COD
                                                            </label>
                                                        </div>
                                                    </h5>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="card-header" id="headingThree">
                                                    <h5 class="mb-0">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="razorPay" id="razorPayCheckbox" checked>
                                                            <label class="form-check-label" for="razorPayCheckbox ">
                                                                RazorPay
                                                            </label>
                                                        </div>
                                                    </h5>
                                                </div>
                                            </div>
                                        </div>

                           <% if (existing) { %>
                                <h4 class=" text-danger my-4 p-3 border">
                                    Selected slot is no longer available. Please choose another slot.
                                </h4>
                            <% } else { %>
                                <div class="order-button-payment mt-20">
                                    <button type="button" id="placeOrderBtn" class="btn" style="background-color: #525151; color: white;">
                                        Place order
                                    </button>
                                </div>
                            <% } %>

                                    </div>
                                </div>

                </div>
            </div>
        </section>



        <!-- Modal for add address -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">New Address</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">
                    <form id="addressForm">
                        <div class="">
                            <label for="" class="m-0 p-0">Name</label><br>
                            <small id="addErrName" class="text-danger"></small><br>
                            <input type="text" name="name" class="form-control form-control-lg" id="name" placeholder="Your Name"> <br>
        
                            <label for="" class="m-0 p-0">Address</label><br>
                            <small id="addErrAddress" class="text-danger"></small><br>
                            <input type="text" name="address" class="form-control form-control-lg" id="address" placeholder="Enter your address"><br>
        
                            <label for="" class="m-0 p-0">District</label><br>
                            <small id="addErrDistrict" class="text-danger"></small><br>
                            <input type="text" name="district" class="form-control form-control-lg" id="district" placeholder="Town or city"><br>
        
                            
                            <div class="d-flex justify-content-between" >
                                <div class="pr-2">
                                    <label for="" class="m-0 p-0">State</label><br>
                                    <small id="addErrState" class="text-danger"></small><br>
                                    <input type="text" name="state" class="form-control form-control-lg" id="state" placeholder="Enter your state"><br>
                                </div>
                                <div>
                                    <label for="" class="m-0 p-0">Postal Code</label><br>
                                    <small id="addErrPin" class="text-danger"></small><br>
                                    <input type="number" name="zip" class="form-control form-control-lg" id="zip" placeholder="Zip/Postal"><br>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">

                                <div class="pr-2">
                                    <label for="" class="m-0 p-0">Email Address</label><br>
                                    <small id="addErrEmail" class="text-danger"></small><br>
                                    <input type="text" name="email" class="form-control form-control-lg" id="email" placeholder="">
                                </div>
            
                                <div>
                                    <label for="" class="m-0 p-0">Phone Number</label><br>
                                    <small id="addErrPhone" class="text-danger"></small><br>
                                    <input type="number" name="phone" class="form-control form-control-lg" id="phone" placeholder=""><br>
                                </div>
                            </div>
        

                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" id="submitAddressBtn" class="btn btn-secondary">Submit</button>
                        </div>

                    </form>   

                </div>

            </div>
            </div>
        </div>
        

    </main>






                              
          
    <!-- footer  -->
    <%- include('../partials/footer') %>
    

    
            <!-- Bootstrap JS and jQuery -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <!-- SweetAlert CDN -->
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
            <!-- Include Axios -->
            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
            <script>

        
    
                document.addEventListener("DOMContentLoaded", function() {
                    var checkboxes = document.querySelectorAll('.payment-method input[type="checkbox"]');
                    checkboxes.forEach(function(checkbox) {
                        checkbox.addEventListener('change', function() {
                            checkboxes.forEach(function(otherCheckbox) {
                                if (otherCheckbox !== checkbox) {
                                    otherCheckbox.checked = false;
                                }
                            });
                        });
                    });
                });
                const checkboxes = document.querySelectorAll('.delivery-address');
    
                // Add event listener to each checkbox
                checkboxes.forEach((checkbox) => {
                checkbox.addEventListener('change', function() {
                    // If this checkbox is checked, uncheck all others
                    if (this.checked) {
                    checkboxes.forEach((otherCheckbox) => {
                        if (otherCheckbox !== this) {
                        otherCheckbox.checked = false;
                        }
                    });
                    }
                });
                });
    
                document.getElementById('placeOrderBtn').addEventListener("click",async ()=>{
    
                    const placeOrderBtn = document.getElementById('placeOrderBtn');
                    const cashOnDeliveryCheckbox = document.getElementById('cashOnDeliveryCheckbox');
                    const razorPayCheckbox = document.getElementById('razorPayCheckbox');
                    const totalPriceElement = document.getElementById('orderTotal');
                    const totalPrice = totalPriceElement.textContent;
    
                    console.log("totalPrice order Placed : ", totalPrice)
    
                    const selectedAddressId = document.querySelector('input[type="checkbox"]:checked').getAttribute('data-address-id');
                    if(selectedAddressId === null){
                        Toastify({
                            text: "Please select an address",
                            duration: 2000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "orange",
                        }).showToast();
                        return false
                    }
                    let paymentMethod = '';
    
                    if (cashOnDeliveryCheckbox.checked) {
                        paymentMethod = 'Cash On Delivery';
                    } else if (razorPayCheckbox.checked) {
                        console.log(razorPayCheckbox.checked);
                        paymentMethod = 'RazorPay';
                    }
    
                    try {
                        if (paymentMethod === 'Cash On Delivery') {
                            const response = await axios.post('/book/cod', {
                                selectedAddressId: selectedAddressId,
                                serviceId : "<%= service._id %>",
                                date : "<%= date %>",
                                slot : "<%= slot %>",
                            });
                            showOrderSuccessMessage(response.data);
                        } else if (paymentMethod === 'RazorPay') {
                            handleRazorpayPayment(selectedAddressId,"<%= service._id %>", "<%= date %>", "<%= slot %>");
                        }
                    } catch (error) {
                        console.error('Error placing order:', error.response.data);
                        Toastify({
                            text: "Error placing order. Pls try again",
                            duration: 2000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "orange",
                        }).showToast();
                    }
                    
    
    
                    
                    async function handleRazorpayPayment(selectedAddressId,serviceId,date, slot) {
                        if(selectedAddressId === null){
                            Toastify({
                                text: "Please select an address",
                                duration: 2000,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "orange",
                            }).showToast();
                            return false
                        }
                        try {
                            const response = await axios.post('/booking/razorPay', {    
                                selectedAddressId,
                                serviceId,
                                date,
                                slot
                            });
    
                            const { orderId, amount, keyId } = response.data;
    
                            const options = {
                                key: keyId,
                                amount: amount,
                                currency: 'INR',
                                name: 'Smart cleaning service',
                                description: 'Smart cleaning service razorpay booking test',
                                image: 'https://example.com/your_logo.png',
                                order_id: orderId,
                                handler: function (response) {
                                    
                                    axios.post("/razorpay-verify",{ response, selectedAddressId, serviceId, date, slot})
                                    .then((respons)=>{
                                        console.log(respons);
                                        showBookingSuccessMessage(respons.data)
                                    })
                                    .catch((error)=>{
                                        console.log(error);
                                    })
                                
                                },
                                prefill: {
                                    name: 'ABHINAV B MANOJ',
                                    email: 'abhinavbmanoj@gmail.com',
                                    contact: '9567267515',
                                },
                                theme: {
                                    color: '#F37254',
                                },
                            };
    
                            const rzp = new Razorpay(options);
                            rzp.open();
                        } catch (error) {
                            console.error('Error creating Razorpay order:', error);
                        }
                    }
    
                    function showBookingSuccessMessage(data) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Booking Successfull!',
                            html: `Your booking with ID <strong>${data.orderId}</strong> has been placed.<br>
                            Total Price: <strong>${totalPrice}</strong><br>`,
                            confirmButtonText: "Ok"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = `/userProfile?scrollTo=orders`
                            }
                        });
                    }
                });
    

        // ADD NEW ADDRESS - CHECKOUT AREA
        document.getElementById("submitAddressBtn").addEventListener("click", function() {
            document.getElementById('addErrName').textContent = ''
            document.getElementById('addErrAddress').textContent = ''
            document.getElementById('addErrDistrict').textContent = ''
            document.getElementById('addErrState').textContent = ''
            document.getElementById('addErrPin').textContent = ''
            document.getElementById('addErrEmail').textContent = ''
            document.getElementById('addErrPhone').textContent = ''


            // Get form data
            const formData = {
                name: document.getElementById("name").value,
                address: document.getElementById("address").value,
                district: document.getElementById("district").value,
                state: document.getElementById("state").value,
                zip: document.getElementById("zip").value,
                email: document.getElementById("email").value,
                phone: document.getElementById("phone").value
            };

            // VALIDATION
            if (formData.name.trim() === '') {
                document.getElementById('addErrName').textContent = 'Please enter your name.'
                return false;
            }

            if (formData.address.trim() === '') {
                document.getElementById('addErrAddress').textContent = 'Please enter your address.'
                return false;
            }

            if (formData.district.trim() === '') {
                document.getElementById('addErrDistrict').textContent = 'Please enter your district.'
                return false;
            }

            if (formData.state.trim() === '') {
                document.getElementById('addErrState').textContent = 'Please enter your state.'
                return false;
            }

            if (formData.zip.trim() === '') {
                document.getElementById('addErrPin').textContent = 'Please enter your postal code.'
                return false;
            }

            if (formData.email.trim() === '') {
                document.getElementById('addErrEmail').textContent = 'Please enter your email address.'
                return false;
            }

            if (formData.phone.trim() === '') {
                document.getElementById('addErrPhone').textContent = 'Please enter your phone number.'
                return false;
            }


            axios.post('/add-address', formData)
            .then(function (response) {
                $('#exampleModal').modal('hide');
                window.location.href = "/checkout"
            })
            .catch(function (error) {
                console.error('Error adding address:', error);
            });
        });
    </script>
    <!-- axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.4.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JS here -->
    <script src="js/vendor/jquery-1.12.4.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/isotope.pkgd.min.js"></script>
    <script src="js/one-page-nav-min.js"></script>
    <script src="js/slick.min.js"></script>
    <script src="js/jquery.meanmenu.min.js"></script>
    <script src="js/ajax-form.js"></script>
    <script src="js/fontawesome.min.js"></script>
    <script src="js/wow.min.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/jquery.scrollUp.min.js"></script>
    <script src="js/imagesloaded.pkgd.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/main.js"></script>
</body>


</html>